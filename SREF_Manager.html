<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Midjourney SREF Manager</title>
    <link href="https://fonts.googleapis.com/css2?display=swap&family=Inter%3Awght@400;500;700;900&family=Noto+Sans%3Awght@400;500;700;900" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <style>
        body {
            font-family: Inter, "Noto Sans", sans-serif;
        }
        .sref-item {
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            opacity: 1;
            transform: scale(1);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .sref-item.hidden-item {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            position: absolute; /* To allow remaining items to reflow */
        }
        .sref-item h3 {
            font-weight: bold;
            font-size: 1.25rem;
            color: #333;
        }
        .sref-item .sref-code-display {
            background-color: #f3f4f6;
            padding: 8px 12px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            display: inline-block;
            cursor: pointer;
        }
        .sref-item .actions {
            display: flex;
            gap: 8px;
        }
        .sref-item .actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            color: white;
        }
        .sref-item .actions .edit-btn {
            background-color: #ffc107;
            color: #333;
        }
        .sref-item .actions .delete-btn {
            background-color: #dc3545;
            color: white;
        }
        .image-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
        }
        .image-container img {
            width: 100%;
            height: auto;
            border-radius: 6px;
            object-fit: cover;
            border: 1px solid #ddd;
            cursor: pointer;
        }
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        .tag {
            background-color: #e0f2fe;
            color: #0c4a6e;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .tag.selected {
            background-color: #1173d4;
            color: white;
        }
        .tag:hover {
            background-color: #b9e0f2;
        }
        .tag.selected:hover {
            background-color: #0f63b6;
        }
        .search-container {
            margin-bottom: 24px;
        }
        .toggle-button {
            background-color: #555;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .toggle-button:hover {
            background-color: #333;
        }

        /* Lightbox Styles */
        .lightbox {
            display: none;
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(0, 0, 0, 0.85) 0%, rgba(0, 0, 0, 0.5) 50%, rgba(0, 0, 0, 0) 100%);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            justify-content: center;
            align-items: center;
        }

        .lightbox-content {
            max-width: 90vw;
            max-height: 90vh;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 10px;
        }

        .lightbox-content img {
            display: block;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 25px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }

        .open-url-btn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1173d4;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            display: none;
        }

        .open-url-btn:hover {
            background-color: #0f63b6;
        }
        .toast-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        .toast-message.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .filtered-view {
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body class="bg-gray-50">
<div class="relative flex size-full min-h-screen flex-col bg-white group/design-root overflow-x-hidden" style='font-family: Inter, "Noto Sans", sans-serif;'>
    <div class="layout-container flex h-full grow flex-col">
        <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-gray-200 px-10 py-4">
            <div class="flex items-center gap-3 text-gray-800">
                <div class="size-6 text-[#1173d4]">
                    <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                        <path d="M36.7273 44C33.9891 44 31.6043 39.8386 30.3636 33.69C29.123 39.8386 26.7382 44 24 44C21.2618 44 18.877 39.8386 17.6364 33.69C16.3957 39.8386 14.0109 44 11.2727 44C7.25611 44 4 35.0457 4 24C4 12.9543 7.25611 4 11.2727 4C14.0109 4 16.3957 8.16144 17.6364 14.31C18.877 8.16144 21.2618 4 24 4C26.7382 4 29.123 8.16144 30.3636 14.31C31.6043 8.16144 33.9891 4 36.7273 4C40.7439 4 44 12.9543 44 24C44 35.0457 40.7439 44 36.7273 44Z" fill="currentColor"></path>
                    </svg>
                </div>
                <h2 class="text-gray-800 text-xl font-bold leading-tight tracking-[-0.015em]">SREF Code Manager</h2>
            </div>
            <div class="flex flex-1 justify-end gap-6">
            </div>
        </header>

        <main class="flex-1 bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
            <div class="max-w-xl mx-auto bg-white rounded-xl shadow-sm p-8">
                <div class="mb-4 text-center">
                    <button id="toggle-button" class="inline-flex items-center justify-center py-2 px-4 text-sm font-medium text-white bg-[#1173d4] hover:bg-[#0f63b6] rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#1173d4]">Show Saved Codes</button>
                </div>
                
                <div id="form-view" class="space-y-6">
                    <div class="mb-8">
                        <h1 class="text-gray-900 text-3xl font-bold leading-tight">Add New SREF Code</h1>
                        <p class="text-gray-500 mt-1">Fill in the details below to add a new SREF code to your collection.</p>
                    </div>
                    <div class="mb-6 border-b pb-6 border-dashed border-gray-300">
                        <label for="mj-prompt" class="block text-sm font-medium text-gray-700">Paste your Midjourney prompt here</label>
                        <div class="mt-1 flex gap-2">
                            <textarea id="mj-prompt" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-[#1173d4] focus:ring-[#1173d4] sm:text-sm h-24 px-4 py-2" placeholder="e.g. /imagine a vibrant city landscape --sref 12345 --v 6.1"></textarea>
                            <button id="parse-button" type="button" class="inline-flex items-center justify-center py-2 px-4 text-sm font-medium text-white bg-gray-500 hover:bg-gray-700 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                <span class="material-symbols-outlined text-sm">auto_fix_high</span> Extract SREF
                            </button>
                        </div>
                    </div>
                    <form>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700" for="style-reference">Style Reference (Code or Image URL)</label>
                                <input class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[#1173d4] focus:ring-[#1173d4] sm:text-sm h-12 px-4" id="style-reference" placeholder="e.g. 123456789 or https://..." type="text"/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700" for="mj-version">MJ Version</label>
                                <select class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[#1173d4] focus:ring-[#1173d4] sm:text-sm h-12 px-4" id="mj-version">
                                    <option value="">None</option>
                                    <option value="V7">V7</option>
                                    <option value="V6.1">V6.1</option>
                                    <option value="V6">V6</option>
                                    <option value="Niji 6">Niji 6</option>
                                    <option value="V5.2">V5.2</option>
                                    <option value="V5.1">V5.1</option>
                                    <option value="V5">V5</option>
                                    <option value="Test">Test</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-6">
                            <label class="block text-sm font-medium text-gray-700" for="sref-name">Name</label>
                            <input class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[#1173d4] focus:ring-[#1173d4] sm:text-sm h-12 px-4" id="sref-name" placeholder="e.g. Vintage Film Look" type="text"/>
                        </div>
                        <div class="mt-6">
                            <label class="block text-sm font-medium text-gray-700" for="sref-tags">Tags</label>
                            <input class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[#1173d4] focus:ring-[#1173d4] sm:text-sm h-12 px-4" id="sref-tags" placeholder="Add tags separated by commas" type="text"/>
                            <p class="mt-2 text-sm text-gray-500">e.g. vibrant, abstract, cinematic</p>
                        </div>
                        <div class="mt-6">
                            <label class="block text-sm font-medium text-gray-700" for="additional-descriptors">Additional Descriptors</label>
                            <textarea id="additional-descriptors" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[#1173d4] focus:ring-[#1173d4] sm:text-sm h-24 px-4 py-2" placeholder="--ar 16:9 --stylize 50 --chaos 25"></textarea>
                            <p class="mt-2 text-sm text-gray-500">Parameters automatically populated from your prompt.</p>
                        </div>

                        <div class="mt-8">
                            <h2 class="text-gray-800 text-lg font-bold">Example Images</h2>
                            <p class="text-sm text-gray-500 mt-1">You can upload from your computer or provide URLs below.</p>
                        </div>
                        
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Upload from Computer</label>
                            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                                <div class="space-y-1 text-center">
                                    <span class="material-symbols-outlined text-5xl text-gray-400">cloud_upload</span>
                                    <div class="flex text-sm text-gray-600">
                                        <label class="relative cursor-pointer bg-white rounded-md font-medium text-[#1173d4] hover:text-[#0f63b6] focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-[#1173d4]" for="file-upload">
                                            <span>Upload up to 4 files</span>
                                            <input class="sr-only" id="file-upload" multiple="" name="file-upload" type="file" accept="image/png, image/jpeg, image/gif"/>
                                        </label>
                                        <p class="pl-1">or drag and drop</p>
                                    </div>
                                    <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
                                </div>
                            </div>
                            <div id="image-previews" class="image-container mt-4"></div>
                        </div>

                        <div class="mt-6">
                            <h3 class="text-sm font-medium text-gray-700 mb-2">Image URLs</h3>
                            <div class="space-y-3">
                                <input class="block w-full rounded-md border-gray-300 shadow-sm focus:border-[#1173d4] focus:ring-[#1173d4] sm:text-sm h-12 px-4" id="image-url-1" placeholder="Image URL 1" type="url"/>
                                <input class="block w-full rounded-md border-gray-300 shadow-sm focus:border-[#1173d4] focus:ring-[#1173d4] sm:text-sm h-12 px-4" id="image-url-2" placeholder="Image URL 2" type="url"/>
                                <input class="block w-full rounded-md border-gray-300 shadow-sm focus:border-[#1173d4] focus:ring-[#1173d4] sm:text-sm h-12 px-4" id="image-url-3" placeholder="Image URL 3" type="url"/>
                                <input class="block w-full rounded-md border-gray-300 shadow-sm focus:border-[#1173d4] focus:ring-[#1173d4] sm:text-sm h-12 px-4" id="image-url-4" placeholder="Image URL 4" type="url"/>
                            </div>
                        </div>

                        <div class="pt-6 flex justify-end gap-3">
                            <input type="hidden" id="entry-id">
                            <button id="save-button" class="inline-flex justify-center py-3 px-6 border border-transparent shadow-sm text-sm font-bold rounded-md text-white bg-[#1173d4] hover:bg-[#0f63b6] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#1173d4]" type="button">Save Code</button>
                        </div>
                    </form>
                </div>

                <div id="list-view" class="hidden">
                    <div class="mb-8">
                        <h1 class="text-gray-900 text-3xl font-bold leading-tight">Saved SREF Codes</h1>
                        <p class="text-gray-500 mt-1">Your personal collection of Midjourney style references.</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                        <div class="search-container mb-4 md:mb-0">
                            <input class="block w-full rounded-md border-gray-300 shadow-sm focus:border-[#1173d4] focus:ring-[#1173d4] sm:text-sm h-12 px-4" id="general-search" placeholder="Search by name or tags" type="text"/>
                        </div>
                        <div class="search-container">
                            <label class="block text-sm font-medium text-gray-700" for="version-filter">Filter by MJ Version</label>
                            <select class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[#1173d4] focus:ring-[#1173d4] sm:text-sm h-12 px-4" id="version-filter">
                                <option value="all">All Versions</option>
                                <option value="V7">V7</option>
                                <option value="V6.1">V6.1</option>
                                <option value="V6">V6</option>
                                <option value="Niji 6">Niji 6</option>
                                <option value="V5.2">V5.2</option>
                                <option value="V5.1">V5.1</option>
                                <option value="V5">V5</option>
                                <option value="Test">Test</option>
                            </select>
                        </div>
                    </div>
                    <div id="active-filter" class="flex items-center gap-2 mb-4 hidden">
                        <span class="text-sm font-medium text-gray-600">Active Filter:</span>
                        <span id="active-tag-name" class="bg-gray-200 text-gray-800 px-3 py-1 rounded-full text-sm font-bold"></span>
                        <button id="clear-filter-btn" class="text-red-500 hover:text-red-700 text-sm font-medium">Clear</button>
                    </div>
                    <div id="sref-list" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                        <!-- SREF items will be rendered here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- The Lightbox Modal -->
    <div id="lightbox" class="lightbox">
        <span class="close-btn">&times;</span>
        <div class="lightbox-content">
            <img id="lightbox-image" src="" alt="Enlarged image">
            <a id="open-url-btn" class="open-url-btn" href="#" target="_blank">Open Original URL</a>
        </div>
    </div>

    <!-- Toast Message -->
    <div id="toast-message" class="toast-message"></div>
</div>

<script>
    const saveButton = document.getElementById('save-button');
    const parseButton = document.getElementById('parse-button');
    const srefList = document.getElementById('sref-list');
    const generalSearchInput = document.getElementById('general-search');
    const versionFilterSelect = document.getElementById('version-filter');
    const formIdInput = document.getElementById('entry-id');
    const toggleButton = document.getElementById('toggle-button');
    const formView = document.getElementById('form-view');
    const listView = document.getElementById('list-view');
    const fileUpload = document.getElementById('file-upload');
    const imagePreviewsContainer = document.getElementById('image-previews');
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightbox-image');
    const closeBtn = document.querySelector('.close-btn');
    const openUrlBtn = document.getElementById('open-url-btn');
    const toastMessage = document.getElementById('toast-message');
    const activeFilterContainer = document.getElementById('active-filter');
    const activeTagName = document.getElementById('active-tag-name');
    const clearFilterBtn = document.getElementById('clear-filter-btn');
    const styleReferenceInput = document.getElementById('style-reference');
    const imageUrlInputs = [
        document.getElementById('image-url-1'),
        document.getElementById('image-url-2'),
        document.getElementById('image-url-3'),
        document.getElementById('image-url-4')
    ];

    let localImageUrls = [];
    let srefData = JSON.parse(localStorage.getItem('srefData')) || [];
    let currentFilteredTag = null;

    function showToast(message) {
        toastMessage.textContent = message;
        toastMessage.classList.add('visible');
        setTimeout(() => {
            toastMessage.classList.remove('visible');
        }, 2000);
    }
    
    function renderList(filteredData) {
        // Use document fragment for performance
        const fragment = document.createDocumentFragment();
        
        if (filteredData.length === 0) {
            srefList.innerHTML = '<p class="text-center text-gray-500">No codes found. Add a new one using the form!</p>';
            return;
        }

        filteredData.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.classList.add('sref-item');
            
            const styleRefHtml = item.styleReference && !isUrl(item.styleReference) ? `<div class="sref-code-display" data-code="${item.styleReference}">--sref ${item.styleReference}</div>` : '';
            const styleRefImageHtml = item.styleReference && isUrl(item.styleReference) ? `<img src="${item.styleReference}" alt="Style Reference image" class="h-24" data-original-url="${item.styleReference}">` : '';

            itemElement.innerHTML = `
                <h3>${item.name}</h3>
                ${styleRefHtml}
                ${item.mjVersion ? `<p class="text-sm text-gray-500"><strong>Version:</strong> ${item.mjVersion}</p>` : ''}
                <div class="tag-container">
                    ${item.tags.map(tag => `<span class="tag" data-tag="${tag}">${tag}</span>`).join('')}
                </div>
                ${(item.imageUrls && item.imageUrls.length > 0) || (styleRefImageHtml) ? `
                <div class="image-container">
                    ${styleRefImageHtml}
                    ${item.imageUrls.map(url => `<img src="${url}" alt="Example image" class="h-24" data-original-url="${url}">`).join('')}
                </div>
                ` : ''}
                <div class="actions">
                    <button class="edit-btn bg-yellow-500 hover:bg-yellow-600 text-white" data-id="${item.id}">Edit</button>
                    <button class="delete-btn bg-red-500 hover:bg-red-600 text-white" data-id="${item.id}">Delete</button>
                </div>
            `;
            fragment.appendChild(itemElement);
        });

        // Clear and append at once
        srefList.innerHTML = '';
        srefList.appendChild(fragment);

        attachEventListeners();
    }
    
    function isUrl(str) {
        return str.startsWith('http://') || str.startsWith('https://');
    }

    function attachEventListeners() {
        document.querySelectorAll('.sref-code-display').forEach(div => {
            div.addEventListener('click', (e) => {
                const code = e.target.getAttribute('data-code');
                document.execCommand('copy', false, `--sref ${code}`);
                showToast('SREF code copied to clipboard!');
            });
        });

        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const id = e.target.getAttribute('data-id');
                const entry = srefData.find(item => item.id === id);
                if (entry) {
                    formIdInput.value = entry.id;
                    document.getElementById('sref-name').value = entry.name;
                    document.getElementById('style-reference').value = entry.styleReference || '';
                    document.getElementById('mj-version').value = entry.mjVersion || '';
                    document.getElementById('sref-tags').value = entry.tags.join(', ');
                    
                    imagePreviewsContainer.innerHTML = '';
                    fileUpload.value = '';
                    localImageUrls = [];
                    
                    // Clear all URL fields
                    imageUrlInputs.forEach(input => input.value = '');

                    if (entry.imageUrls) {
                        entry.imageUrls.forEach((url, index) => {
                            if (isUrl(url) && index < imageUrlInputs.length) {
                                imageUrlInputs[index].value = url;
                            } else if (!isUrl(url)) {
                                // For base64 data, we can't put it in the URL input, so we use the preview container
                                const img = document.createElement('img');
                                img.src = url;
                                img.alt = `Preview`;
                                img.classList.add('h-24', 'rounded-md', 'object-cover');
                                imagePreviewsContainer.appendChild(img);
                                localImageUrls.push(url);
                            }
                        });
                    }

                    saveButton.textContent = 'Update Code';
                    formView.classList.remove('hidden');
                    listView.classList.add('hidden');
                    toggleButton.textContent = 'Show Saved Codes';
                    activeFilterContainer.classList.add('hidden');
                }
            });
        });

        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const id = e.target.getAttribute('data-id');
                srefData = srefData.filter(item => item.id !== id);
                localStorage.setItem('srefData', JSON.stringify(srefData));
                filterAndRender();
            });
        });
        
        // Add event listeners for lightbox
        document.querySelectorAll('.image-container img').forEach(img => {
            img.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent filter clearing on image click
                const imageUrl = e.target.getAttribute('data-original-url');
                lightboxImage.src = imageUrl;
                lightbox.style.display = 'flex';
                
                if (imageUrl.startsWith('data:')) {
                    openUrlBtn.style.display = 'none';
                } else {
                    openUrlBtn.style.display = 'inline-block';
                    openUrlBtn.href = imageUrl;
                }
            });
        });

        // Add event listener for tags
        document.querySelectorAll('.tag').forEach(tag => {
            tag.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent filter clearing on tag click
                const selectedTag = e.target.getAttribute('data-tag');
                filterByTag(selectedTag);
            });
        });
    }

    // Lightbox close functionality
    closeBtn.addEventListener('click', () => {
        lightbox.style.display = 'none';
    });
    
    lightbox.addEventListener('click', (e) => {
        if (e.target === lightbox) {
            lightbox.style.display = 'none';
        }
    });

    // New event listener for clearing filter
    document.body.addEventListener('click', (e) => {
        const isClickInsideList = document.getElementById('list-view').contains(e.target);
        const isFormView = !formView.classList.contains('hidden');

        if (!isClickInsideList && !isFormView && currentFilteredTag) {
            clearFilter();
        }
    });

    function clearFilter() {
        currentFilteredTag = null;
        generalSearchInput.value = '';
        versionFilterSelect.value = 'all';
        activeFilterContainer.classList.add('hidden');
        renderList(srefData);
    }

    function saveEntry() {
        const id = formIdInput.value;
        const name = document.getElementById('sref-name').value.trim();
        const styleReference = styleReferenceInput.value.trim() || null;
        const mjVersion = document.getElementById('mj-version').value || null;
        const tags = document.getElementById('sref-tags').value.split(',').map(tag => tag.trim().toLowerCase()).filter(tag => tag);
        const additionalDescriptors = document.getElementById('additional-descriptors').value.trim();

        if (!name) {
            showToast('Please enter a name for your entry.');
            return;
        }

        if (!styleReference && localImageUrls.length === 0 && imageUrlInputs.every(input => !input.value.trim())) {
            showToast('Please enter a Style Reference or at least one Image.');
            return;
        }
        
        const urlImages = imageUrlInputs.map(input => input.value.trim()).filter(url => url);
        const allImageUrls = [...localImageUrls, ...urlImages];

        const newEntry = {
            id: id || Date.now().toString(),
            name,
            styleReference,
            mjVersion,
            tags,
            additionalDescriptors,
            imageUrls: allImageUrls
        };

        if (id) {
            srefData = srefData.map(item => item.id === id ? newEntry : item);
        } else {
            srefData.push(newEntry);
        }

        localStorage.setItem('srefData', JSON.stringify(srefData));
        document.getElementById('sref-name').value = '';
        styleReferenceInput.value = '';
        document.getElementById('mj-version').value = '';
        document.getElementById('sref-tags').value = '';
        document.getElementById('additional-descriptors').value = '';
        fileUpload.value = '';
        imageUrlInputs.forEach(input => input.value = '');
        imagePreviewsContainer.innerHTML = '';
        localImageUrls = [];
        formIdInput.value = '';
        saveButton.textContent = 'Save Code';
        filterAndRender();
        showToast('Entry saved successfully!');
    }
    
    saveButton.addEventListener('click', saveEntry);

    // List of common words to ignore when creating tags
    const stopWords = new Set([
        'a', 'an', 'the', 'in', 'on', 'with', 'and', 'or', 'for', 'of', 'from', 'to', 'is', 'are', 'was', 'were', 'it', 'its', 'their', 'they', 'at', 'by', 'as', 'into', 'my', 'your', 'his', 'her', 'its', 'our', 'their', 'this', 'that', 'these', 'those'
    ]);

    // Function to populate the form from the Midjourney prompt
    function populateFromPrompt() {
        const promptText = document.getElementById('mj-prompt').value;
        if (!promptText.trim()) {
            showToast('Please paste a prompt first.');
            return;
        }

        const parts = promptText.split('--');
        let promptBody = parts[0].trim();
        let descriptors = [];
        let styleReference = '';
        let mjVersion = '';
        
        if (promptBody.startsWith('/imagine')) {
            promptBody = promptBody.substring('/imagine'.length).trim();
        }

        // Parse parameters
        for (let i = 1; i < parts.length; i++) {
            const param = parts[i].trim();
            if (param.startsWith('sref')) {
                const srefMatch = param.match(/sref\s+(\S+)/);
                if (srefMatch) {
                    styleReference = srefMatch[1];
                }
            } else if (param.startsWith('v ') || param.startsWith('version ')) {
                const versionMatch = param.match(/(v|version)\s+(\S+)/);
                if (versionMatch) {
                    mjVersion = versionMatch[2].toUpperCase();
                }
            } else {
                descriptors.push(`--${param}`);
            }
        }

        // Populate form fields
        styleReferenceInput.value = styleReference;
        document.getElementById('sref-name').value = promptBody;
        document.getElementById('mj-version').value = mjVersion || '';
        document.getElementById('additional-descriptors').value = descriptors.join(' ');
        
        // Generate and populate tags
        const words = promptBody.toLowerCase().replace(/[^a-z0-9\s]/g, '').split(' ');
        const tags = words.filter(word => word.length > 2 && !stopWords.has(word));
        document.getElementById('sref-tags').value = [...new Set(tags)].join(', ');

        showToast('Form populated from prompt!');
    }
    parseButton.addEventListener('click', populateFromPrompt);

    function filterAndRender() {
        const query = generalSearchInput.value.trim().toLowerCase();
        const versionFilter = versionFilterSelect.value;
        
        let filtered = srefData;

        if (versionFilter !== 'all') {
            filtered = filtered.filter(entry => entry.mjVersion === versionFilter);
        }

        if (currentFilteredTag) {
            filtered = filtered.filter(entry => entry.tags.includes(currentFilteredTag));
        }

        if (query.length > 0) {
            filtered = filtered.filter(entry => {
                const nameMatch = entry.name.toLowerCase().includes(query);
                const tagsMatch = entry.tags.some(tag => tag.includes(query));
                return nameMatch || tagsMatch;
            });
        }
        
        renderList(filtered);
    }

    generalSearchInput.addEventListener('input', filterAndRender);
    versionFilterSelect.addEventListener('change', filterAndRender);
    clearFilterBtn.addEventListener('click', clearFilter);

    function filterByTag(tag) {
        currentFilteredTag = tag;
        generalSearchInput.value = '';
        versionFilterSelect.value = 'all';
        activeTagName.textContent = tag;
        activeFilterContainer.classList.remove('hidden');
        filterAndRender();
    }
    
    toggleButton.addEventListener('click', () => {
        if (formView.classList.contains('hidden')) {
            formView.classList.remove('hidden');
            listView.classList.add('hidden');
            toggleButton.textContent = 'Show Saved Codes';
        } else {
            formView.classList.add('hidden');
            listView.classList.remove('hidden');
            toggleButton.textContent = 'Show Entry Form';
            filterAndRender();
        }
    });

    fileUpload.addEventListener('change', (e) => {
        const files = e.target.files;
        if (files) {
            localImageUrls = [];
            imagePreviewsContainer.innerHTML = '';
            for (let i = 0; i < files.length && i < 4; i++) {
                const file = files[i];
                const reader = new FileReader();
                reader.onload = (event) => {
                    const imageUrl = event.target.result;
                    localImageUrls.push(imageUrl);
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.alt = `Preview ${i + 1}`;
                    img.classList.add('h-24', 'rounded-md', 'object-cover');
                    imagePreviewsContainer.appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        }
    });

    filterAndRender();
</script>

</body>
</html>
